<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QCBOR: Building</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">QCBOR
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Building</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="Building"></a></p>
<h2><a class="anchor" id="autotoc_md12"></a>
Building</h2>
<p>The library is built solely from the src and inc directores. The inc directory contains the public interface. The test app and such are in other directories.</p>
<p>There is a basic makefile that will build the library and command line test app. CMake is also available, please read the "Building with CMake" section for more information.</p>
<p>QCBOR will compile and fully function without any build configuration or set up. It is 100% portable.</p>
<p>There are a number of C preprocessor #defines that can be set. Their primary purpose is to reduce library object code sizes by disabling features. A couple slightly improve performance. See the comment sections on "Configuration" in inc/UsefulBuf.h and the pre processor defines that start with QCBOR_DISABLE_XXX.</p>
<p>The test directory includes the tests that are nearly as portable as the main implementation. If your development environment doesn't support UNIX style command line and make, you should be able to make a simple project and add the test files to it. Then just call RunTests() to invoke them all.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Building with CMake</h3>
<p>CMake can also be used to build QCBOR and the test application. Having the root <code>CMakeLists.txt</code> file, QCBOR can be easily integrated with your project's existing CMake environment. The result of the build process is a static library, to build a shared library instead you must add the <code>-DBUILD_SHARED_LIBS=ON</code> option at the CMake configuration step. The tests can be built into a simple command line application to run them as it was mentioned before; or it can be built as a library to be integrated with your development environment. The <code>BUILD_QCBOR_TEST</code> CMake option can be used for building the tests, it can have three values: <code>APP</code>, <code>LIB</code> or <code>OFF</code> (default, test are not included in the build).</p>
<p>Building the QCBOR library:</p>
<div class="fragment"><div class="line">cd &lt;QCBOR_base_folder&gt;</div>
<div class="line"># Configuring the project and generating a native build system</div>
<div class="line">cmake -S . -B &lt;build_folder&gt;</div>
<div class="line"># Building the project</div>
<div class="line">cmake --build &lt;build_folder&gt;</div>
</div><!-- fragment --><p>Building and running the QCBOR test app: </p><div class="fragment"><div class="line">cd &lt;QCBOR_base_folder&gt;</div>
<div class="line"># Configuring the project and generating a native build system</div>
<div class="line">cmake -S . -B &lt;build_folder&gt; -DBUILD_QCBOR_TEST=APP</div>
<div class="line"># Building the project</div>
<div class="line">cmake --build &lt;build_folder&gt;</div>
<div class="line"># Running the test app</div>
<div class="line">.&lt;build_folder&gt;/test/qcbortest</div>
</div><!-- fragment --><p>To enable all the compiler warnings that are used in the QCBOR release process you can use the <code>BUILD_QCBOR_WARN</code> option at the CMake configuration step: </p><div class="fragment"><div class="line">cmake -S . -B &lt;build_folder&gt; -DBUILD_QCBOR_WARN=ON</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md14"></a>
Floating Point Support &amp; Configuration</h3>
<p>By default, all QCBOR floating-point features are enabled:</p>
<ul>
<li>Encoding and decoding of basic float types, single and double-precision</li>
<li>Encoding and decoding of half-precision with conversion to/from single and double-precision</li>
<li>Preferred serialization of floating-point</li>
<li>Floating point dates</li>
<li>Methods that can convert big numbers, decimal fractions and other numbers to/from floating-point</li>
</ul>
<p>If full floating-point is not needed, the following #defines can be used to reduce object code size and dependency.</p>
<p>See discussion in <a class="el" href="qcbor__encode_8h_source.html">qcbor_encode.h</a> for other details.</p>
<h4><a class="anchor" id="autotoc_md15"></a>
#define QCBOR_DISABLE_FLOAT_HW_USE</h4>
<p>This removes dependency on:</p>
<ul>
<li>Floating-point hardware and floating-point instructions</li>
<li><code>&lt;math.h&gt;</code> and <code>&lt;fenv.h&gt;</code></li>
<li>The math library (libm, -lm)</li>
</ul>
<p>For most limited environments, this removes enough floating-point dependencies to be able to compile and run QCBOR.</p>
<p>Note that this does not remove use of the types double and float from QCBOR, but it limits QCBOR's use of them to converting the encoded byte stream to them and copying them. Converting and copying them usually don't require any hardware, libraries or includes. The C compiler takes care of it on its own.</p>
<p>QCBOR uses its own implementation of half-precision float-pointing that doesn't depend on math libraries. It uses masks and shifts instead. Thus, even with this define, half-precision encoding and decoding works.</p>
<p>When this is defined, the QCBOR functionality lost is minimal and only for decoding:</p>
<ul>
<li>Decoding floating-point format dates are not handled</li>
<li>There is no conversion between floats and integers when decoding. For example, <a class="el" href="qcbor__number__decode_8h.html#a9033cdff92cb8c04a33a9510e90adbd6" title="Decode next item into an unsigned 64-bit integer with conversions.">QCBORDecode_GetUInt64ConvertAll()</a> will be unable to convert to and from float-point.</li>
<li>Floats will be unconverted to double when decoding.</li>
</ul>
<p>No interfaces are disabled or removed with this define. If input that requires floating-point conversion or functions are called that request floating-point conversion, an error code like <code>QCBOR_ERR_HW_FLOAT_DISABLED</code> will be returned.</p>
<p>This saves only a small amount of object code. The primary purpose for defining this is to remove dependency on floating point hardware and libraries.</p>
<h4><a class="anchor" id="autotoc_md16"></a>
#define QCBOR_DISABLE_PREFERRED_FLOAT</h4>
<p>This eliminates support of:</p><ul>
<li>encode/decode of half-precision</li>
<li>shortest-form encoding of floats</li>
<li><a class="el" href="qcbor__number__decode_8h.html#ad0bb02b1de3486a30b27778c31fe95ba" title="dCBOR Decode next as a number with precision-preserving conversions.">QCBORDecode_GetNumberConvertPrecisely()</a></li>
</ul>
<p>This saves about 1KB of object code, though much of this can be saved by not calling any functions to encode doubles or floats or <a class="el" href="qcbor__number__decode_8h.html#ad0bb02b1de3486a30b27778c31fe95ba" title="dCBOR Decode next as a number with precision-preserving conversions.">QCBORDecode_GetNumberConvertPrecisely()</a></p>
<p>With this defined, single and double-precision floating-point numbers can still be encoded and decoded. Some conversion of floating-point to and from integers, big numbers and such is also supported. Floating-point dates are still supported.</p>
<h4><a class="anchor" id="autotoc_md17"></a>
#define USEFULBUF_DISABLE_ALL_FLOAT</h4>
<p>This eliminates floating point support completely (along with related function headers). This is useful if the compiler options deny the usage of floating point operations completely, and the usage of a soft floating point ABI is not possible.</p>
<h4><a class="anchor" id="autotoc_md18"></a>
Compiler options</h4>
<p>Compilers support a number of options that control which float-point related code is generated. For example, it is usually possible to give options to the compiler to avoid all floating-point hardware and instructions, to use software and replacement libraries instead. These are usually bigger and slower, but these options may still be useful in getting QCBOR to run in some environments in combination with <code>QCBOR_DISABLE_FLOAT_HW_USE</code>. In particular, <code>-mfloat-abi=soft</code>, disables use of hardware instructions for the float and double types in C for some architectures.</p>
<h4><a class="anchor" id="autotoc_md19"></a>
CMake options</h4>
<p>If you are using CMake, it can also be used to configure the floating-point support. These options can be enabled by adding them to the CMake configuration step and setting their value to 'ON' (True). The following table shows the available options and the associated #defines. </p><pre class="fragment">| CMake option                      | #define                       |
|-----------------------------------|-------------------------------|
| QCBOR_OPT_DISABLE_FLOAT_HW_USE    | QCBOR_DISABLE_FLOAT_HW_USE    |
| QCBOR_OPT_DISABLE_FLOAT_PREFERRED | QCBOR_DISABLE_PREFERRED_FLOAT |
| QCBOR_OPT_DISABLE_FLOAT_ALL       | USEFULBUF_DISABLE_ALL_FLOAT   |
</pre><p><a class="anchor" id="CodeSize"></a></p>
<h2><a class="anchor" id="autotoc_md20"></a>
Code Size</h2>
<p>These are approximate sizes on a 64-bit x86 CPU with the -Os optimization. All QCBOR_DISABLE_XXX are set and compiler stack frame checking is disabled for smallest but not for largest. Smallest is the library functions for a protocol with strings, integers, arrays, maps and Booleans, but not floats and standard tag types. </p><pre class="fragment">|               | smallest | largest |
|---------------|----------|---------|
| encode only   |          |         |
| decode only   |          |         |
| combined      |          |         |
</pre><p>From the table above, one can see that the amount of code pulled in from the QCBOR library varies a lot, ranging from 1KB to 15KB. The main factor is the number of QCBOR functions called and which ones they are. QCBOR minimizes internal interdependency so only code necessary for the called functions is brought in.</p>
<p>Encoding is simpler and smaller. An encode-only implementation may bring in only 1KB of code.</p>
<p>Encoding of floating-point brings in a little more code as does encoding of tagged types and encoding of bstr wrapping.</p>
<p>Basic decoding using <a class="el" href="qcbor__main__decode_8h.html#a5822b9efabd2a4bb1ce13390bf378b61" title="Preorder traversal like QCBORDecode_VGetNext() without use of internal error state.">QCBORDecode_GetNext()</a> brings in 3KB.</p>
<p>Use of the supplied MemPool by calling <a class="el" href="qcbor__main__decode_8h.html#aee2d572e423cfed0a2c774b2999c53dc" title="Set up the MemPool string allocator for indefinite-length strings.">QCBORDecode_SetMemPool()</a> to setup to decode indefinite-length strings adds 0.5KB.</p>
<p>Basic use of spiffy decode to brings in about 3KB. Using more spiffy decode functions, such as those for tagged types bstr wrapping brings in more code.</p>
<p>Finally, use of all of the integer conversion functions will bring in about 5KB, though you can use the simpler ones like <a class="el" href="qcbor__number__decode_8h.html#ab76004afe285f4e7589d00c0d0c2df33" title="Decode next item into a signed 64-bit integer.">QCBORDecode_GetInt64()</a> without bringing in very much code.</p>
<p>In addition to using fewer QCBOR functions, the following are some ways to make the code smaller.</p>
<p>The gcc compiler output is usually smaller than llvm because stack guards are off by default (be sure you actually have gcc and not llvm installed to be invoked by the gcc command). You can also turn off stack gaurds with llvm. It is safe to turn off stack gaurds with this code because Usefulbuf provides similar defenses and this code was carefully written to be defensive.</p>
<p>If QCBOR is installed as a shared library, then of course only one copy of the code is in memory no matter how many applications use it.</p>
<h3><a class="anchor" id="autotoc_md21"></a>
Disabling Features</h3>
<p>The main control over the amount of QCBOR code that gets linked is through which QCBOR functions are used. Linking against a library or dead stripping will eliminate all code not explicitly called.</p>
<p>In addition to using fewer QCBOR functions, the following #defines can be set to further reduce code size. For example, QCBOR_DISABLE_ENCODE_USAGE_GUARDS will reduce the size of many common encoding functions by performing less error checking (but not compromising any code safety).</p>
<p>The amounts saved listed below are approximate. They depends on the CPU, the compiler, configuration, which functions are use and so on.</p>
<pre class="fragment">| #define                                 | Saves |
| ----------------------------------------| ------|
| QCBOR_DISABLE_ENCODE_USAGE_GUARDS       |       |
| QCBOR_DISABLE_INDEFINITE_LENGTH_STRINGS |       |
| QCBOR_DISABLE_INDEFINITE_LENGTH_ARRAYS  |       |
| QCBOR_DISABLE_EXP_AND_MANTISSA          |       |
| QCBOR_DISABLE_PREFERRED_FLOAT           |       |
| QCBOR_DISABLE_FLOAT_HW_USE              |       |
| QCBOR_DISABLE_TAGS                      |       |
| QCBOR_DISABLE_NON_INTEGER_LABELS        |       |
| USEFULBUF_DISABLE_ALL_FLOAT             |       |
</pre><p>QCBOR_DISABLE_ENCODE_USAGE_GUARDS affects encoding only. It doesn't disable any encoding features, just some error checking. Disable it when you are confident that an encoding implementation is complete and correct.</p>
<p>Indefinite lengths are a feature of CBOR that makes encoding simpler and the decoding more complex. They allow the encoder to not have to know the length of a string, map or array when they start encoding it. Their main use is when encoding has to be done on a very constrained device. Conversely when decoding on a very constrained device, it is good to prohibit use of indefinite lengths so the decoder can be smaller.</p>
<p>The QCBOR decode API processes both definite and indefinite lengths with the same API, except to decode indefinite-length strings a storage allocator must be configured.</p>
<p>To reduce the size of the decoder define QCBOR_DISABLE_INDEFINITE_LENGTH_STRINGS particularly if you are not configuring a storage allocator.</p>
<p>Further reduction can be by defining QCBOR_DISABLE_INDEFINITE_LENGTH_ARRAYS which will result in an error when an indefinite-length map or array arrives for decoding.</p>
<p>QCBOR_DISABLE_UNCOMMON_TAGS is removed from QCBOR v2. It didn't save very much and you can get the same effect by not installing the tag content handlers.</p>
<p>QCBOR_DISABLE_EXP_AND_MANTISSA disables the decoding of decimal fractions and big floats.</p>
<p><a class="anchor" id="QCBOR_DISABLE_TAGS"></a>QCBOR_DISABLE_TAGS disables all CBOR tag decoding. If the input has a single tag, the unrecoverable error, <a class="el" href="qcbor__common_8h.html#a917c840b71af72c2cdd4b31bb2a4fb42a6bff182e866ace827e025f9cea5e6cf4">QCBOR_ERR_TAGS_DISABLED</a>, occurs. The decoder is suitable only for protocols that have no tags. This reduces the size of the core of the decoder, particularly <a class="el" href="qcbor__main__decode_8h.html#a247d735e59b26e9dfab807b045d1b01b" title="Get the next item (integer, byte string, array...) in the preorder traversal of the CBOR tree.">QCBORDecode_VGetNext()</a>, by a about 500 bytes. "Borrowed" tag content formats (e.g. an epoch-based date without the tag number), can still be processed. See <a class="el" href="qcbor__tag__decode_8h.html#Disabilng-Tag-Decoding">Disabilng-Tag-Decoding</a>.</p>
<p>QCBOR_DISABLE_NON_INTEGER_LABELS causes any label that doesn't fit in an int64_t to result in a QCBOR_ERR_MAP_LABEL_TYPE error. This also disables QCBOR_DECODE_MODE_MAP_AS_ARRAY and QCBOR_DECODE_MODE_MAP_STRINGS_ONLY. It is fairly common for CBOR-based protocols to use only small integers as labels.</p>
<p>See the discussion above on floating-point.</p>
<h3><a class="anchor" id="autotoc_md22"></a>
Size of spiffy decode</h3>
<p>When creating a decode implementation, there is a choice of whether or not to use spiffy decode features or to just use <a class="el" href="qcbor__main__decode_8h.html#a5822b9efabd2a4bb1ce13390bf378b61" title="Preorder traversal like QCBORDecode_VGetNext() without use of internal error state.">QCBORDecode_GetNext()</a>.</p>
<p>The implementation using spiffy decode will be simpler resulting in the calling code being smaller, but the amount of code brought in from the QCBOR library will be larger. Basic use of spiffy decode brings in about 2KB of object code. If object code size is not a concern, then it is probably better to use spiffy decode because it is less work, there is less complexity and less testing to worry about.</p>
<p>If code size is a concern, then use of <a class="el" href="qcbor__main__decode_8h.html#a5822b9efabd2a4bb1ce13390bf378b61" title="Preorder traversal like QCBORDecode_VGetNext() without use of internal error state.">QCBORDecode_GetNext()</a> will probably result in smaller overall code size for simpler CBOR protocols. However, if the CBOR protocol is complex then use of spiffy decode may reduce overall code size. An example of a complex protocol is one that involves decoding a lot of maps or maps that have many data items in them. The overall code may be smaller because the general purpose spiffy decode map processor is the one used for all the maps. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
