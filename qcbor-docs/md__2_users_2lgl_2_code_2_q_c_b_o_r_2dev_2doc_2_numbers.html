<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QCBOR: Numbers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">QCBOR
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Numbers</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="BigNumbers"></a> </p>
<h1><a class="anchor" id="autotoc_md23"></a>
Big Numbers</h1>
<h2><a class="anchor" id="autotoc_md24"></a>
Basics</h2>
<p>Big numbers are integers that can be as long and as large as desired, limited only by the amount of memory allocated for them.</p>
<p>They are represented as a byte string plus an indication of sign. The most significant byte is first (network byte order) both in the encoded form and as input and output by QCBOR APIs.</p>
<p>CBOR has only one encoded representation of zero for integers, big numbers included. That means the whole negative number space is offset by one. Since big numbers are encoded as a sign and some bytes, the steps to encode a negative value are to take the absolute value and then adjust by one. On encoding, the adjustment is to subtract one from the absolute value, and on decoding to add one to the absolute value.</p>
<p>Take -256 as an example. It is represented in memory with two bytes, 0x01 0x00, plus indication that it is negative, perhaps a boolean. When it is CBOR-encoded it becomes 0xff plus an indication of the sign.</p>
<p>Notice that the length changed. This is one place in the design of CBOR where the bytes off the wire cannot be simply used as they are. This has an effect on the big number encoding and decoding APIs.</p>
<p>The tag numbers 2 and 3 indicate a big number. The tag content is a byte string with the absolute value of the big number, offset by one when negative. Tag number 2 indicates positive and 3 negative.</p>
<p>For example, 256 encoded as a positive big number is 0xc2 0x42 0x01 0x00 and -256 encodes as 0xc3 0x41 0xff (non-preferred; see preferred example in next section).</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Preferred Serialization</h2>
<p>The integer number space encodable by big numbers overlaps with the number space encodable by regular integers, by CBOR type 0 and type 1, the range from -(2^64) to (2^64)-1.</p>
<p>RFC 8949 big number preferred serialization requires that numbers in the type 0 and 1 integer range must not be encoded as big numbers. They must be encoded as type 0 and type 1 integers.</p>
<p>For example, 256 must be encoded as 0x19 0x01 0x00 and -256 as 0x38 0xff.</p>
<p>One purpose of this is to save some bytes, but typically only one byte is saved. The more important reason for this is determinism. There is only one way to represent a particular value.</p>
<p>Technically speaking, this reduction of the big number space to the integer space is not about serialization. It doesn't change the way big numbers and integers are serialized by themselves.</p>
<p>Note, also that CBOR can encode what can be called "65-big negative
numbers", 64 bits of precision and one bit to indicate a negative one. These can't be represented by 64-bit two's compliment signed integers or 64-bit unsigned integers. While many programming environments, like Ruby and Python that have big number support built in will support these, some environments like C and the CPU instructions do not. QCBOR big number decoding supports them with explicit code to carry the negative number in as a uint64_t and a sign indicator. Big number specific preferred serialization requires encoding of 65-bit negative integers. Other than big numbers QCBOR avoids 65-big negative integers.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
QCBOR APIs</h2>
<p>The negative number offset of one and the reduction required by big number preferred serialization have a large effect on the QCBOR big number API.</p>
<p><a class="el" href="qcbor__number__encode_8h.html#abdbf65bd1f0ee7787f1b143a74537208" title="Add a big number to encoded output using preferred serialization.">QCBOREncode_AddTBigNumber()</a> and <a class="el" href="qcbor__number__decode_8h.html#ae137587767f6f83cc4c0f49719f17d1e" title="Decode next item as a big number encoded using preferred serialization.">QCBORDecode_GetTBigNumber()</a> are the most comprehensive and easiest to use APIs. They automatically take care of the offset of one for negative numbers and big number preferred serialization. Unlike most other decode APIs, <a class="el" href="qcbor__number__decode_8h.html#ae137587767f6f83cc4c0f49719f17d1e" title="Decode next item as a big number encoded using preferred serialization.">QCBORDecode_GetTBigNumber()</a> requires an output buffer of sufficient size.</p>
<p>If the protocol being implemented does not use preferred serialization, then <a class="el" href="qcbor__number__encode_8h.html#ac75b50fb0b98919652e1304b4339c4bb" title="Add a big number to encoded output without preferred serialization.">QCBOREncode_AddTBigNumberNoPreferred()</a> and <a class="el" href="qcbor__number__decode_8h.html#a9974e592ec77ce559eb0537de0dc5b96" title="Decode next item as a big number without preferred serialization.">QCBORDecode_GetTBigNumberNoPreferred()</a> can be used. Only tags 2 and 3 will be output when encoding. Type 0 and 1 integers will never be output. Decoding will error if type 0 and type 1 integers are encountered.</p>
<p>It is likely that any implementation for a protocol that uses big numbers will link in a big number library. When that's so, it can be used to offset the negative numbers by one rather than the internal implementation that QCBOR has. If both the offset by one and the preferred serialization are side-stepped, the big numbers APIs become simple pass throughs for encoding and decoding byte strings. This reduces the amount of object linked from the QCBOR library by about 1KB.</p>
<p>This is what <a class="el" href="qcbor__number__encode_8h.html#ad1d71f5ec9daa192e4fb4c908744b79c" title="Add a big number to encoded output with no processing.">QCBOREncode_AddTBigNumberRaw()</a> and <a class="el" href="qcbor__number__decode_8h.html#a9b04d8c382925cd9e6bfa75a8f59a0b4" title="Decode the next item as a big number with no processing.">QCBORDecode_GetTBigNumberRaw()</a> do. Note that decoding doesn't require an output buffer be supplied because the bytes off the wire can simply be returned. When these are used, the big number library should be used to add one to negative numbers before encoding and subtract one from negative numbers after decoding.</p>
<p>Last, <a class="el" href="qcbor__tag__decode_8h.html#a8068561f5838cd8038010eb229fbd7ed" title="Process standard CBOR tags whose content is a string.">QCBORDecode_StringsTagCB()</a>, <a class="el" href="qcbor__main__decode_8h.html#adaa198d9c5262e614999afd356b653ba">QCBOR_TYPE_POSBIGNUM</a>, <a class="el" href="qcbor__main__decode_8h.html#ae9c803e8cc9062cda64c79ce227ec6ab">QCBOR_TYPE_NEGBIGNUM</a>, and <a class="el" href="qcbor__number__decode_8h.html#abefb66b268a527b0feccf5cc30218150" title="Decode a preferred serialization big number.">QCBORDecode_ProcessBigNumber()</a> need to be described. QCBOR's tag processing callbacks can be used to handle big numbers by installing <a class="el" href="qcbor__tag__decode_8h.html#a8068561f5838cd8038010eb229fbd7ed" title="Process standard CBOR tags whose content is a string.">QCBORDecode_StringsTagCB()</a> for tag numbers 2 and 3. This will result in positive and negative big numbers being returned in a <a class="el" href="qcbor__main__decode_8h.html#af9cda6b7e1f5c811c87a80551f2f5647">QCBORItem</a> as QCBOR types <a class="el" href="qcbor__main__decode_8h.html#adaa198d9c5262e614999afd356b653ba">QCBOR_TYPE_POSBIGNUM</a> and <a class="el" href="qcbor__main__decode_8h.html#ae9c803e8cc9062cda64c79ce227ec6ab">QCBOR_TYPE_NEGBIGNUM</a>. <a class="el" href="qcbor__tag__decode_8h.html#a8068561f5838cd8038010eb229fbd7ed" title="Process standard CBOR tags whose content is a string.">QCBORDecode_StringsTagCB()</a> is very simple, and not much object code. Neither the offset of one for negative values nor preferred serialization number reduction is preformed. It is equivalent to <a class="el" href="qcbor__number__decode_8h.html#a9b04d8c382925cd9e6bfa75a8f59a0b4" title="Decode the next item as a big number with no processing.">QCBORDecode_GetTBigNumberRaw()</a>.</p>
<p><a class="el" href="qcbor__number__decode_8h.html#abefb66b268a527b0feccf5cc30218150" title="Decode a preferred serialization big number.">QCBORDecode_ProcessBigNumber()</a> may be used to fully process a <a class="el" href="qcbor__main__decode_8h.html#af9cda6b7e1f5c811c87a80551f2f5647">QCBORItem</a> that is expected to be a big number. It will perform the negative offset and handle the preferred serialization number reduction. <a class="el" href="qcbor__number__decode_8h.html#abefb66b268a527b0feccf5cc30218150" title="Decode a preferred serialization big number.">QCBORDecode_ProcessBigNumber()</a> is what is used internally to implement <a class="el" href="qcbor__number__decode_8h.html#ae137587767f6f83cc4c0f49719f17d1e" title="Decode next item as a big number encoded using preferred serialization.">QCBORDecode_GetTBigNumber()</a> and links in a lot of object code. Note that <a class="el" href="qcbor__number__decode_8h.html#abefb66b268a527b0feccf5cc30218150" title="Decode a preferred serialization big number.">QCBORDecode_ProcessBigNumber()</a> requires an output buffer be supplied.</p>
<p>QCBORDecode_ProcessBigNumbernoPreferred() is the same as <a class="el" href="qcbor__number__decode_8h.html#abefb66b268a527b0feccf5cc30218150" title="Decode a preferred serialization big number.">QCBORDecode_ProcessBigNumber()</a> but will error out if the <a class="el" href="qcbor__main__decode_8h.html#af9cda6b7e1f5c811c87a80551f2f5647">QCBORItem</a> contains anything but <a class="el" href="qcbor__main__decode_8h.html#adaa198d9c5262e614999afd356b653ba">QCBOR_TYPE_POSBIGNUM</a>, <a class="el" href="qcbor__main__decode_8h.html#ae9c803e8cc9062cda64c79ce227ec6ab">QCBOR_TYPE_NEGBIGNUM</a>.</p>
<p>Note that if <a class="el" href="qcbor__tag__decode_8h.html#a8068561f5838cd8038010eb229fbd7ed" title="Process standard CBOR tags whose content is a string.">QCBORDecode_StringsTagCB()</a> is installed, <a class="el" href="qcbor__number__decode_8h.html#ae137587767f6f83cc4c0f49719f17d1e" title="Decode next item as a big number encoded using preferred serialization.">QCBORDecode_GetTBigNumber()</a>, <a class="el" href="qcbor__number__decode_8h.html#a9974e592ec77ce559eb0537de0dc5b96" title="Decode next item as a big number without preferred serialization.">QCBORDecode_GetTBigNumberNoPreferred()</a> and <a class="el" href="qcbor__number__decode_8h.html#a9b04d8c382925cd9e6bfa75a8f59a0b4" title="Decode the next item as a big number with no processing.">QCBORDecode_GetTBigNumberRaw()</a> all still work as documented.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
"Borrowed" Big Number Tag Content</h2>
<p>Like all other tag decoding functions in QCBOR, the big number tag decoders can also work with borrowed tag content for big numbers. For example, the value of a map item might be specified that it be decoded as a big number even though there is no tag number indicating so.</p>
<p>The main thing to mention here is that without a tag number, there's nothing in the encoded CBOR to indicate the sign. That must be indicated some other way. For example, it might be that the map item is defined to always be a positive big number.</p>
<p>On the encode side, that means the sign boolean is ignored when <a class="el" href="qcbor__number__encode_8h.html#abdbf65bd1f0ee7787f1b143a74537208" title="Add a big number to encoded output using preferred serialization.">QCBOREncode_AddTBigNumber()</a> is called with <code>uTagRequirement</code> other than <a class="el" href="qcbor__tag__encode_8h.html#a859fc2ba4ffffb16ba54afc066053c4ca2f721f7caeeef1b48f4e797d9fd0e4f2">QCBOR_ENCODE_AS_TAG</a>.</p>
<p>On the decode side, the sign boolean becomes an input parameter rather than an output parameter so that <a class="el" href="qcbor__number__decode_8h.html#ae137587767f6f83cc4c0f49719f17d1e" title="Decode next item as a big number encoded using preferred serialization.">QCBORDecode_GetTBigNumber()</a> can know whether to apply the offset of one in case the value is negative.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Big Number Conversions</h2>
<p>QCBOR provides a number of decode functions that can convert big numbers to other representations like floating point. For example, see <a class="el" href="qcbor__number__decode_8h.html#a16b7746a76f69a514983315c37d7fd62" title="Decode next item as a double floating-point value with conversion.">QCBORDecode_GetDoubleConvertAll()</a>.</p>
<p>Note also that <a class="el" href="qcbor__number__decode_8h.html#abefb66b268a527b0feccf5cc30218150" title="Decode a preferred serialization big number.">QCBORDecode_ProcessBigNumber()</a> can convert integers to big numbers. It will work even if the protocol item is never supposed to be a big number. It will just happily convert any type 0 or type 1 CBOR integer to a big number.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Backwards Compatibility with QCBOR v1</h2>
<p>QCBOR v1 supports only the minimal pass through processing of big numbers, not the offset of one for negative values or the big number specific preferred serialization. The main functions in v1 are <a class="el" href="qcbor__number__encode_8h.html#a6a1fe72ac5bc5d80effabaa679cf466b">QCBOREncode_AddTPositiveBignum()</a>, <a class="el" href="qcbor__number__encode_8h.html#a232ca83a9708b37e1378ede1e7f50ed3">QCBOREncode_AddTNegativeBignum()</a> and <a class="el" href="qcbor__number__decode_8h.html#a4674ca54feefc7d756c4d534c6c58859" title="[Deprecated] Decode big number with no processing.">QCBORDecode_GetBignum()</a>. These are equivalent to <a class="el" href="qcbor__number__encode_8h.html#ad1d71f5ec9daa192e4fb4c908744b79c" title="Add a big number to encoded output with no processing.">QCBOREncode_AddTBigNumberRaw()</a> and <a class="el" href="qcbor__number__decode_8h.html#a9b04d8c382925cd9e6bfa75a8f59a0b4" title="Decode the next item as a big number with no processing.">QCBORDecode_GetTBigNumberRaw()</a>.</p>
<p>Also, in v1 <a class="el" href="qcbor__common_8h.html#a47367e57493f51fbf0253df494a17743">CBOR_TAG_POS_BIGNUM</a> and <a class="el" href="qcbor__common_8h.html#acf35c30486c5c22bc76934951d106a19">CBOR_TAG_NEG_BIGNUM</a> are always processed into a <a class="el" href="qcbor__main__decode_8h.html#af9cda6b7e1f5c811c87a80551f2f5647">QCBORItem</a> of type <a class="el" href="qcbor__main__decode_8h.html#adaa198d9c5262e614999afd356b653ba">QCBOR_TYPE_POSBIGNUM</a> and <a class="el" href="qcbor__main__decode_8h.html#ae9c803e8cc9062cda64c79ce227ec6ab">QCBOR_TYPE_NEGBIGNUM</a> by an equivalent of QCBORDecode_StringsTagCB.</p>
<p>All the v1 methods for big numbers such as <a class="el" href="qcbor__number__encode_8h.html#a6a1fe72ac5bc5d80effabaa679cf466b">QCBOREncode_AddTPositiveBignum()</a> and <a class="el" href="qcbor__number__decode_8h.html#a4674ca54feefc7d756c4d534c6c58859" title="[Deprecated] Decode big number with no processing.">QCBORDecode_GetBignum()</a> are fully supported in v2. When <a class="el" href="qcbor__tag__decode_8h.html#a8068561f5838cd8038010eb229fbd7ed" title="Process standard CBOR tags whose content is a string.">QCBORDecode_StringsTagCB()</a> is installed for tags 2 and 3 such as by calling <a class="el" href="qcbor__main__decode_8h.html#afc65a0f8f3aed0e4d193e68753e1c9e2" title="[Deprecated] Configure CBOR decoder context for QCBOR v1 compatibility.">QCBORDecode_CompatibilityV1()</a>, QCBOR v2 big number behavior is 100% backwards compatible. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
